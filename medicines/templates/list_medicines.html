{% load static %}
{% load custom_filters %}
<!DOCTYPE html>
<html>

<head>
    <title>Listagem de Medicamentos</title>
    <link rel="stylesheet" href="{% static 'health/styles.css' %}">
    <style>
        .studies,
        p {
            margin-left: 30px;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="nav">
            <div class="search-container">
                <form id="search-form" action="{% url 'listar_medicamentos' %}">
                    {% if search_query %}
                    <input type="text" id="search-input" name="search" value="{{ search_query }}">
                    {% else %}
                    <input type="text" id="search-input" name="search" placeholder="Pesquisar por nome...">
                    {% endif %}
                    <button type="submit"><i class="bi bi-search"></i></button>
                    {% if search_query %}
                    <a href="{% url 'listar_medicamentos' %}" class="" style="margin-right: 10px;">Limpar filtro</a>
                    {% endif %}
                </form>
            </div>
            <br>
            <h1>Medicamentos</h1>
        </div>

        <a href="{% url 'adicionar_consulta' %}"  class="floating-button" style="bottom: 110px; width: 70px; height: 60px;">üíä</a>

        <a href="{% url 'adicionar_medicamento' %}" class="floating-button"
            style="width: 70px; height: 60px; font-size: 40px;">+</a>

        <section class="table__body" style="scale: 0.87">
            <table>
                <thead>
                    <tr>
                        <th>Id <span class="icon-arrow">&UpArrow;</span></th>
                        <th>Nome <span class="icon-arrow">&UpArrow;</span></th>
                        <th>Descri√ß√£o <span class="icon-arrow">&UpArrow;</span></th>
                        <th>Composi√ß√£o <span class="icon-arrow">&UpArrow;</span></th>
                        <th>Usos <span class="icon-arrow">&UpArrow;</span></th>
                        <th>Contra Indica√ß√µes <span class="icon-arrow">&UpArrow;</span></th>
                        <th>Doen√ßas/Situa√ß√µes <span class="icon-arrow">&UpArrow;</span></th>
                        <th>FAQ / Perguntas Frequentes <span class="icon-arrow">&UpArrow;</span></th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody>
                    {% for medicamento in medicamentos %}
                    <tr>
                        <td>{{ medicamento.id }}</td>
                        <td>{{ medicamento.nome_cientifico |truncate_chars:50 }}</td>
                        <td>{{ medicamento.descricao|truncate_chars:50 }}</td>
                        <td>{{ medicamento.composicao|truncate_chars:50 }}</td>
                        <td>{{ medicamento.usos|truncate_chars:50 }}</td>
                        <td>{{ medicamento.contra_indicacoes|truncate_chars:50 }}</td>
                        <td>{{ medicamento.doencas_situacoes|truncate_chars:50 }}</td>
                        <td>{{ medicamento.faq|truncate_chars:50 }}</td>
                        <td>
                            <div style="transform: translateX(30px);">
                                <button class="btn btn-primary modal-btn"
                                    data-modal-target="#modal-{{ medicamento.id }}">
                                    <i class="bi bi-eye"></i> Detalhes
                                </button>
                                <button class="btn btn-primary">
                                    <a href="{% url 'editar_medicamento' medicamento.id %}">
                                        <i class="bi bi-pencil"></i> Editar
                                    </a>
                                </button>
                                <a href="{% url 'excluir_medicamento' medicamento.id %}">
                                    <button class="btn btn-danger btn-excluir" data-item-id="{{ medicamento.id }}">
                                        <i class="bi bi-trash"></i> Excluir
                                    </button>
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </section>
        <!-- Pagina√ß√£o -->
        <div class="pagination">
            <span class="step-links">
                {% if medicamentos.has_previous %}
                <a href="?page=1">&laquo; Primeira p√°gina</a>
                <a href="?page={{ medicamentos.previous_page_number }}">voltar</a>
                {% endif %}

                <span class="current">
                    P√°gina {{ medicamentos.number }} de {{ medicamentos.paginator.num_pages }}.
                </span>

                {% if medicamentos.has_next %}
                <a href="?page={{ medicamentos.next_page_number }}">Pr√≥xima</a>
                <a href="?page={{ medicamentos.paginator.num_pages }}">Ultima &raquo;</a>
                {% endif %}
            </span>
        </div>
    </div>

    <!-- Seu HTML -->

    <!-- Modal -->
    {% for medicamento in medicamentos %}
    <div class="modal" id="modal-{{ medicamento.id }}">
        <div class="modal-content">
            <!-- Conte√∫do detalhado do item -->
            <h2>{{ medicamento.nome }}</h2><br><br>
            <p><b>Descri√ß√£o / O que √©?</b><br> {{ medicamento.descricao|linebreaksbr }}</p><br><br>
            <p><b>Composi√ß√£o:</b><br> {{ medicamento.composicao|linebreaksbr }}</p><br><br>
            <p><b>Usos:</b><br> {{ medicamento.usos|linebreaksbr }}</p><br><br>
            <p><b>Contra Indica√ß√µes:</b><br> {{ medicamento.contra_indicacoes|linebreaksbr }}</p><br><br>
            <p><b>Doen√ßas/Situa√ß√µes:</b><br> {{ medicamento.doencas_situacoes|linebreaksbr }}</p><br><br>
            <p><b>FAQ / Perguntas Frequentes:</b><br> {{ medicamento.faq|linebreaksbr }}</p><br><br>
        </div>
    </div>
    {% endfor %}

    <!-- Add your JavaScript here to handle the modal functionality -->
    <script>
        // Seu c√≥digo JavaScript continua aqui...

    </script>

    <!-- Seu HTML continua abaixo... -->

    <!-- Modal de Confirma√ß√£o de Exclus√£o -->
    <div class="modal" id="modal-excluir">
        <div class="modal-content">
            <h2>Confirma√ß√£o de Exclus√£o</h2>
            <p>Voc√™ tem certeza que deseja excluir este item?</p>
            <div class="modal-buttons">
                <form method="GET" id="form-excluir">
                    {% csrf_token %}
                    <input type="hidden" name="item_id" id="item_id_input">
                    <button type="submit" class="btn btn-primary btn-confirmar">Sim</button>
                </form>
                <button class="btn btn-secondary btn-cancelar">Cancelar</button>
            </div>
        </div>
    </div>
    <!-- Seu HTML continua acima... -->

    <!-- Add your JavaScript here to handle the modal functionality -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const modalBtns = document.querySelectorAll('.modal-btn');
            const modals = document.querySelectorAll('.modal');

            modalBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const target = btn.getAttribute('data-modal-target');
                    const modal = document.querySelector(target);
                    modal.classList.add('open');

                    const itemID = btn.getAttribute('data-item-id');
                    convertToLinks(itemID);
                });
            });

            modals.forEach(modal => {
                modal.addEventListener('click', e => {
                    if (e.target.classList.contains('modal')) {
                        modal.classList.remove('open');
                    }
                });
            });

            function convertToLinks(itemID) {
                const paragraph = document.getElementById(`estudos-cientificos-${itemID}`);
                const content = paragraph.innerHTML;

                // Create a temporary element to parse the content as HTML
                const tempElement = document.createElement('div');
                tempElement.innerHTML = content;

                // Get all the links in the content
                const links = tempElement.getElementsByTagName('a');

                // Create a new HTML content to replace the existing one
                let newContent = '';

                // Iterate through the links and add each link to the new content
                for (const link of links) {
                    newContent += `<a href="${link.href}" target="_blank">${link.innerText}</a><br>`;
                }

                // Replace the content of the paragraph with the modified HTML
                paragraph.innerHTML = newContent;
            }
        });

        $(document).ready(function () {
            var modal = $('#modal-excluir');
            var btnExcluir = $('.btn-excluir');
            var btnConfirmar = $('.btn-confirmar');
            var btnCancela = $('.btn-cancelar');
            var itemId;

            // Abra o modal quando clicar em um dos links de exclus√£o
            btnExcluir.click(function (event) {
                event.preventDefault(); // Impede o comportamento padr√£o de clicar no link
                itemId = $(this).data('item-id');
                console.log(itemId); // Imprime o valor de itemId no console
                modal.modal('show');
                $('#item_id_input').val(itemId); // Armazena o valor do item_id no campo oculto
            });

            // A√ß√£o quando o usu√°rio clicar no bot√£o "Sim" no modal de confirma√ß√£o
            btnConfirmar.click(function () {
                // Realize a a√ß√£o de exclus√£o (submeter o formul√°rio de exclus√£o)
                $('#form-excluir').submit();
            });

            // A√ß√£o quando o modal for ocultado
            modal.on('hidden.bs.modal', function () {
                // Atualize a p√°gina ap√≥s um pequeno atraso
                setTimeout(function () {
                    location.reload();
                }, 100);
            });

            // A√ß√£o quando o usu√°rio clicar no bot√£o "Cancelar" no modal de confirma√ß√£o
            btnCancela.click(function () {
                modal.modal('hide');
            });
        });
    </script>

</body>

</html>